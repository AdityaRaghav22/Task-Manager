<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .task-card {
            transition: transform 0.2s;
        }
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary"><i class="fas fa-tasks me-2"></i>Your Tasks</h2>
                <a href="dashboard.html" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </a>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Add New Task</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-5">
                            <input id="title" class="form-control" placeholder="Task Title">
                        </div>
                        <div class="col-md-5">
                            <input id="description" class="form-control" placeholder="Task Description">
                        </div>
                        <div class="col-md-2">
                            <button onclick="createTask()" class="btn btn-success w-100">
                                <i class="fas fa-plus"></i> Create
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="msg-container">
                <p id="msg" class="text-center fw-bold"></p>
            </div>

            <div id="taskList" class="row">
                <div class="text-center text-muted mt-3">Loading tasks...</div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="app.js"></script>
<script src="utils.js"></script>

<script>
    // Helper to clear inputs after creation
    function clearInputs() {
        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
    }

    // Helper to handle Bootstrap alert styling
    function updateMessageUI(isError, message) {
        const msgEl = document.getElementById("msg");
        msgEl.className = isError ? "alert alert-danger" : "alert alert-success";
        msgEl.innerText = message;
        setTimeout(() => { msgEl.className = "d-none"; }, 3000);
    }

    async function loadTasks() {
        const res = await authFetch(`${API_BASE}/tasks`);
        const data = await res.json();

        // Note: Assuming showError is defined in utils.js. 
        // If utils.js controls "msg" directly, we respect that, 
        // but styling happens via classes above.
        if (!res.ok) { 
            if(typeof showError === 'function') showError("msg", data.msg);
            return; 
        }

        let html = "";
        if(data.length === 0) {
            html = `<div class="col-12 text-center text-muted p-4">No tasks found. Create one above!</div>`;
        } else {
            data.forEach(task => {
                html += `
                <div class="col-12 mb-3">
                    <div class="card task-card border-0 shadow-sm">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-1 text-dark">${task.title}</h5>
                                <p class="card-text text-muted mb-0 small">${task.description}</p>
                            </div>
                            <div class="btn-group">
                                <button onclick="editTask(${task.id})" class="btn btn-outline-warning btn-sm" title="Edit">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button onclick="deleteTask(${task.id})" class="btn btn-outline-danger btn-sm" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
        }

        document.getElementById("taskList").innerHTML = html;
    }

    function editTask(id) {
        window.location.href = `update_task.html?id=${id}`;
    }

    async function createTask() {
        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;

        if(!title || !description) {
            alert("Please fill in both fields");
            return;
        }

        const res = await authFetch(`${API_BASE}/tasks`, {
            method: "POST",
            body: JSON.stringify({ title, description })
        });

        const data = await res.json();

        if (!res.ok) {
            if(typeof showError === 'function') showError("msg", data.msg);
            return;
        }

        clearInputs();
        if(typeof showSuccess === 'function') {
            showSuccess("msg", "Task created successfully!");
        } else {
            updateMessageUI(false, "Task created!");
        }
        
        loadTasks();
    }

    async function deleteTask(id) {
        if(!confirm("Are you sure you want to delete this task?")) return;

        const res = await authFetch(`${API_BASE}/tasks/${id}`, { method: "DELETE" });
        const data = await res.json();

        if (!res.ok) { 
            if(typeof showError === 'function') showError("msg", data.msg);
            return; 
        }

        if(typeof showSuccess === 'function') {
            showSuccess("msg", "Task deleted!");
        } else {
            updateMessageUI(false, "Task deleted!");
        }
        
        loadTasks();
    }

    loadTasks();
</script>

</body>
</html>